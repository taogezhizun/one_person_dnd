<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}one_person_dnd{% endblock %}</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://unpkg.com/marked@12.0.2/marked.min.js"></script>
    <script src="https://unpkg.com/dompurify@3.0.11/dist/purify.min.js"></script>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <header class="header">
      <div class="container header__inner">
        <div class="brand">one_person_dnd</div>
        <nav class="nav">
          <a href="/">主页</a>
          <a href="/saves">存档</a>
          <a href="/memory/world">世界设定</a>
          <a href="/memory/story">剧情摘要</a>
          <a href="/setup">配置</a>
        </nav>
      </div>
    </header>
    <main class="container">
      {% block content %}{% endblock %}
    </main>

    <script>
      (function () {
        function renderMarkdown(root) {
          const scope = root || document;
          if (!window.marked || !window.DOMPurify) return;
          scope.querySelectorAll("[data-md]").forEach((el) => {
            const src = el.textContent || "";
            const html = window.marked.parse(src, { mangle: false, headerIds: false });
            el.innerHTML = window.DOMPurify.sanitize(html);
            el.removeAttribute("data-md");
          });
        }

        function scrollChatToBottom() {
          const el = document.getElementById("chat-history");
          if (!el) return;
          el.scrollTop = el.scrollHeight;
        }

        document.addEventListener("DOMContentLoaded", function () {
          renderMarkdown(document);
          scrollChatToBottom();
        });
        document.body.addEventListener("htmx:afterSwap", function (evt) {
          renderMarkdown(evt.target);
          if (evt.target && evt.target.id === "chat-history") {
            scrollChatToBottom();
          }
        });

        document.body.addEventListener("htmx:afterRequest", function (evt) {
          const elt = evt.detail && evt.detail.elt;
          if (!elt || elt.id !== "turn-form") return;
          // Clear only the main input; keep tags/state for convenience.
          const ta = elt.querySelector("textarea[name=player_text]");
          if (ta) ta.value = "";
        });
      })();
    </script>
  </body>
</html>

